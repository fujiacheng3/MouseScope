{% extends "base.html" %}
{% block title %}分析监控 - MouseScope{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="display-6 gradient-text mb-2"><i class="fas fa-chart-line me-3"></i><span data-i18n="monitor.title">实时分析监控</span></h1>
                <p class="text-secondary" data-i18n="monitor.subtitle">实时追踪分析进度与性能指标</p>
            </div>
            <div class="btn-group">
                <button class="btn btn-danger" id="stopBtn" onclick="stopAnalysis()"><i
                        class="fas fa-stop me-2"></i><span data-i18n="monitor.stop">停止分析</span></button>
                <button class="btn btn-info" onclick="location.reload()"><i class="fas fa-sync-alt me-2"></i><span data-i18n="monitor.refresh">刷新</span></button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- 状态总览 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="cyber-text mb-0"><i class="fas fa-microchip me-2"></i><span data-i18n="monitor.status.title">处理状态</span></h5>
            </div>
            <div class="card-body">
                <div class="data-grid mb-4">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-play-circle"></i></div>
                        <div class="stat-value" id="statusText" data-i18n="monitor.status.loading">加载中...</div>
                        <div class="stat-label" data-i18n="monitor.status.label">分析状态</div>
                        <span class="status-indicator" id="statusIndicator"
                            style="position: absolute; top: 15px; right: 15px;"></span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-percentage"></i></div>
                        <div class="stat-value" id="progressText">0%</div>
                        <div class="stat-label" data-i18n="monitor.progress.label">完成进度</div>
                    </div>
                </div>

                <div class="progress mb-4" style="height: 12px;">
                    <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%" aria-valuenow="0"
                        aria-valuemin="0" aria-valuemax="100"></div>
                </div>

                <div class="tech-panel">
                    <h6 class="gradient-text mb-2"><i class="fas fa-terminal me-2"></i><span data-i18n="monitor.engine">处理状态</span></h6>
                    <div class="bg-dark bg-opacity-50 rounded p-3">
                        <code class="text-info" id="messageText" data-i18n="monitor.waiting">等待引擎响应...</code>
                    </div>
                </div>

                <div id="downloadSection" style="display: none;">
                    <hr>
                    <h6><i class="fas fa-download me-2"></i><span data-i18n="monitor.download.title">下载结果文件</span></h6>
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        <div class="btn-group" role="group">
                            <a href="#" id="downloadAllBtn" class="btn btn-success"><i class="fas fa-archive me-2"></i><span data-i18n="monitor.dl.all">全部下载
                                (ZIP)</span></a>
                            <button type="button" class="btn btn-outline-secondary dropdown-toggle"
                                data-bs-toggle="dropdown"><span data-i18n="monitor.dl.single">单独下载</span></button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" id="dlVideo"><i
                                            class="fas fa-video me-2 text-primary"></i><span data-i18n="monitor.dl.video">分析视频</span></a></li>
                                <li><a class="dropdown-item" href="#" id="dlCsv"><i
                                            class="fas fa-table me-2 text-info"></i><span data-i18n="monitor.dl.csv">详细日志 CSV</span></a></li>
                                <li><a class="dropdown-item" href="#" id="dlImmCsv"><i
                                            class="fas fa-chart-bar me-2 text-success"></i><span data-i18n="monitor.dl.immcsv">统计数据 CSV</span></a></li>
                                <li><a class="dropdown-item" href="#" id="dlReport"><i
                                            class="fas fa-file-alt me-2 text-warning"></i><span data-i18n="monitor.dl.report">报告 TXT</span></a></li>
                            </ul>
                        </div>
                        <button class="btn btn-info" onclick="openResultFolder()">
                            <i class="fas fa-folder-open me-2"></i><span data-i18n="monitor.open.folder">打开结果文件夹</span>
                        </button>
                    </div>
                    <div id="resultPathInfo" class="alert alert-secondary mt-2" style="display:none;">
                        <i class="fas fa-folder me-2"></i>
                        <strong data-i18n="monitor.path.label">结果保存位置：</strong>
                        <code id="resultPathText" class="ms-1"></code>
                    </div>
                    <div class="alert alert-info mt-2">
                        <small><strong>文件说明:</strong> ZIP包含分析视频、帧数据CSV、不动时间CSV和文字报告。<br>
                        <i class="fas fa-lightbulb me-1 text-warning"></i>桌面端可直接点击"打开结果文件夹"在文件管理器中查看。</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- 性能指标 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="cyber-text mb-0"><i class="fas fa-tachometer-alt me-2"></i><span data-i18n="monitor.perf.title">性能指标</span></h5>
            </div>
            <div class="card-body">
                <div class="data-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-film"></i></div>
                        <div class="stat-value" id="processedFrames">0</div>
                        <div class="stat-label">已处理帧</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-stopwatch"></i></div>
                        <div class="stat-value" id="elapsedTime">0s</div>
                        <div class="stat-label">运行时间</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-rocket"></i></div>
                        <div class="stat-value" id="processingSpeed">0</div>
                        <div class="stat-label">处理速度 (fps)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 侧边栏 -->
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="cyber-text mb-0"><i class="fas fa-satellite-dish me-2"></i>实时数据</h6>
            </div>
            <div class="card-body">
                <div id="realtimeData">
                    <div class="tech-panel text-center">
                        <div class="tech-spinner mb-3"></div>
                        <p class="text-muted">等待分析数据...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h6 class="cyber-text mb-0"><i class="fas fa-terminal me-2"></i>系统日志</h6>
            </div>
            <div class="card-body p-0">
                <div id="logContainer" class="terminal-log">
                    <div class="terminal-header">
                        <div class="terminal-controls">
                            <span class="terminal-btn terminal-close"></span>
                            <span class="terminal-btn terminal-minimize"></span>
                            <span class="terminal-btn terminal-maximize"></span>
                        </div>
                        <span class="terminal-title">analysis.log</span>
                    </div>
                    <div class="terminal-content">
                        <p class="text-success"><span class="text-warning">$</span> 等待日志输出...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const sessionId = '{{ session_id }}';
    let updateInterval;

    function updateStatus() {
        fetch(`/api/status/${sessionId}`)
            .then(r => r.json())
            .then(data => {
                if (data.error) return;

                document.getElementById('statusText').textContent = getStatusText(data.status);
                document.getElementById('statusIndicator').className = `status-indicator status-${data.status}`;

                const bar = document.getElementById('progressBar');
                bar.style.width = data.progress + '%';
                bar.textContent = data.progress + '%';
                document.getElementById('progressText').textContent = data.progress + '%';
                document.getElementById('messageText').textContent = data.message || '-';

                if (data.stats) {
                    document.getElementById('processedFrames').textContent = data.stats.processed_frames || 0;
                    document.getElementById('elapsedTime').textContent = (data.stats.elapsed_time || 0).toFixed(1) + 's';
                    document.getElementById('processingSpeed').textContent = (data.stats.fps || 0).toFixed(1) + ' fps';
                }

                // 日志
                const logContainer = document.querySelector('.terminal-content');
                if (data.logs && data.logs.length > 0) {
                    logContainer.innerHTML = data.logs.map(log => {
                        let cls = 'text-success';
                        if (log.includes('错误') || log.includes('Error') || log.includes('❌')) cls = 'text-danger';
                        else if (log.includes('警告') || log.includes('Warning')) cls = 'text-warning';
                        else if (log.includes('完成') || log.includes('✓') || log.includes('✅')) cls = 'text-info';
                        return `<div class="${cls}"><span class="text-warning">$</span> ${log}</div>`;
                    }).join('');
                    logContainer.scrollTop = logContainer.scrollHeight;
                }

                // 实时数据
                const realtimeData = document.getElementById('realtimeData');
                if (data.realtime_data && data.realtime_data.length > 0) {
                    realtimeData.innerHTML = data.realtime_data.map(item => `
                    <div class="data-stream-item ${item.is_struggling ? 'struggling' : 'immobile'}" style="padding:10px; margin:5px 0; border-radius:8px; background:rgba(255,255,255,0.05);">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1 cyber-text">${item.roi_name || 'ROI ' + item.roi_id}</h6>
                                <span class="badge ${item.is_struggling ? 'bg-danger' : 'bg-success'}">
                                    <i class="fas fa-${item.is_struggling ? 'exclamation' : 'check'} me-1"></i>
                                    ${item.is_struggling ? '挣扎' : '静止'}
                                </span>
                            </div>
                            <div class="text-end">
                                <small class="text-muted d-block">光流: ${(item.flow_value || 0).toFixed(1)}</small>
                            </div>
                        </div>
                    </div>`).join('');
                }

                // 完成
                if (data.status === 'completed') {
                    document.getElementById('downloadSection').style.display = 'block';
                    document.getElementById('stopBtn').style.display = 'none';
                    document.getElementById('downloadAllBtn').href = `/api/download_all/${sessionId}`;
                    document.getElementById('dlVideo').href = `/api/download/${sessionId}/video`;
                    document.getElementById('dlCsv').href = `/api/download/${sessionId}/csv`;
                    document.getElementById('dlImmCsv').href = `/api/download/${sessionId}/immobility_csv`;
                    document.getElementById('dlReport').href = `/api/download/${sessionId}/report`;
                    clearInterval(updateInterval);
                    // 获取并显示结果文件夹路径
                    fetchResultDir();
                }
                if (data.status === 'error' || data.status === 'stopped') {
                    clearInterval(updateInterval);
                    document.getElementById('stopBtn').style.display = 'none';
                }
            })
            .catch(e => console.error('状态更新失败:', e));
    }

    function getStatusText(s) {
        return { 'waiting': '等待中', 'preprocessing': '预处理', 'analyzing': '分析中', 'completed': '已完成', 'error': '出错', 'stopped': '已停止' }[s] || s;
    }

    function stopAnalysis() {
        fetch(`/api/stop/${sessionId}`, { method: 'POST' }).then(r => r.json()).then(d => alert(d.message || '已发送停止命令'));
    }

    function openResultFolder() {
        fetch(`/api/open_folder/${sessionId}`, { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    // 文件管理器已打开
                } else {
                    // 打开失败，至少显示路径让用户手动复制
                    alert('打开文件夹失败，结果保存在：\n' + (data.path || '未知路径'));
                }
            })
            .catch(e => {
                console.error('打开文件夹失败:', e);
            });
    }

    function fetchResultDir() {
        fetch(`/api/result_dir/${sessionId}`)
            .then(r => r.json())
            .then(data => {
                if (data.path) {
                    document.getElementById('resultPathInfo').style.display = 'block';
                    document.getElementById('resultPathText').textContent = data.path;
                }
            })
            .catch(e => console.error('获取结果路径失败:', e));
    }

    updateStatus();
    updateInterval = setInterval(updateStatus, 2000);
</script>

<style>
    .data-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
    }

    .stat-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 1.25rem;
        text-align: center;
        position: relative;
        transition: all 0.3s;
    }

    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 242, 254, 0.15);
    }

    .stat-icon {
        font-size: 1.5rem;
        color: var(--accent-color);
        margin-bottom: 0.5rem;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .stat-label {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 0.25rem;
    }

    .terminal-log {
        background: #1a1a2e;
        border-radius: 0 0 12px 12px;
        max-height: 300px;
        overflow: hidden;
    }

    .terminal-header {
        background: rgba(255, 255, 255, 0.08);
        padding: 8px 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .terminal-controls {
        display: flex;
        gap: 6px;
    }

    .terminal-btn {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
    }

    .terminal-close {
        background: #ff5f57;
    }

    .terminal-minimize {
        background: #ffbd2e;
    }

    .terminal-maximize {
        background: #28c840;
    }

    .terminal-title {
        color: var(--text-muted);
        font-size: 0.8rem;
        margin-left: auto;
    }

    .terminal-content {
        padding: 12px;
        font-family: 'Courier New', monospace;
        font-size: 0.8rem;
        max-height: 250px;
        overflow-y: auto;
    }

    .status-analyzing {
        background: var(--accent-color);
        animation: statusPulse 2s ease-in-out infinite;
    }

    .status-completed {
        background: var(--success-color);
    }

    .status-error {
        background: var(--danger-color);
    }

    .status-stopped {
        background: var(--warning-color);
    }

    .tech-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(0, 242, 254, 0.2);
        border-top: 3px solid var(--accent-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    @keyframes statusPulse {

        0%,
        100% {
            transform: scale(1);
            box-shadow: 0 0 5px currentColor;
        }

        50% {
            transform: scale(1.2);
            box-shadow: 0 0 15px currentColor;
        }
    }
</style>
{% endblock %}